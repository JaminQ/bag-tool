<bag-include file="layout.html">
  <bag-slot name="title">Bag Tool</bag-slot>

  <bag-slot name="link">
    <link rel="stylesheet" href="./home.css">
  </bag-slot>

  <bag-slot name="body">
    <div class="page page-projects" :class="{ blur: infoMode || aboutMode }">
      <div class="poster" v-if="projects.length === 0">
        <h1 class="no-select">Bag Tool</h1>
      </div>

      <div id="drop" class="projects-area" v-else @click="nowProjectIdx = '', logMode = false" :style="{ pointerEvents: logMoveStatus ? 'none' : 'inherit' }" @dragover.prevent @dragleave.prevent @dragend.prevent @drop.prevent="dropProject">
        <header class="projects-title">
          Projects
          <button v-if="projects.length" @click="removeMode = !removeMode" class="edit-projects">
            <i v-show="!removeMode" title="编辑项目" class="far fa-edit"></i>
            <i v-show="removeMode" title="完成" class="far fa-check-circle edit-projects-done"></i>
          </button>
        </header>

        <main :style="{ paddingBottom: (nowProjectIdx !== '' ? 70 : 0) + (logMode ? logHeight : 0) + 24 + 'px' }">
          <ul :class="{ 'remove-mode': removeMode }">
            <li v-for="(project, project_i) in projects" @click.stop :class="{ 'move-mode': moveProjectIdx === project_i }">
              <label>
                <input type="radio" :value="project_i" v-model="nowProjectIdx">
                <div class="project-main" :class="{ working: projects[project_i].workStatus }">
                  <i v-if="projects[project_i].workStatus === 'start'" class="project-icon far fa-play-circle"></i>
                  <i v-else class="project-icon fas fa-folder"></i>
                  <div class="project">
                    <div class="project-title">{{ project.title }}</div>
                    <div class="project-path">{{ project.path }}</div>
                  </div>
                  <button class="project-info" @click.stop="infoProject(project_i, project.title)"><i class="fas fa-info-circle" title="查看配置"></i></button>
                  <button class="project-del" @click.stop="removeProject(project_i)"><i class="fas fa-trash-alt" title="移除"></i></button>
                  <button class="project-move" @mousedown="moveProjectStart(project_i)" @mousemove="movingProject" @mouseup="moveProjectEnd"><i class="icon-move" title="移动"></i></button>
                </div>
              </label>
            </li>
          </ul>
        </main>
      </div>

      <transition name="slide-updown">
        <div v-show="nowProjectIdx !== ''" class="work-area" :style="{ bottom: (logMode ? logHeight : 0) + 24 + 'px' }">
          <button class="btn" :class="{ working: nowProject.workStatus === 'build' }" @click="gulp(nowProjectIdx, 'build')">编译{{ nowProject.workStatus === 'build' ? '中...' : '' }}</button>
          <button class="btn" :class="{ working: nowProject.workStatus === 'start' }" @click="gulp(nowProjectIdx, 'start')">监听{{ nowProject.workStatus === 'start' ? '中...' : '' }}</button>
          <button class="btn" :class="{ working: nowProject.workStatus === 'clean' }" @click="gulp(nowProjectIdx, 'clean')">清理{{ nowProject.workStatus === 'clean' ? '中...' : '' }}</button>
        </div>
      </transition>

      <div v-show="logMode" class="log-area" :style="{ height: logHeight + 'px' }">
        <button class="log-empty-btn" :style="{ bottom: logHeight + 'px' }" @click="clearLog(nowProjectIdx)"><i title="清空日志" class="fas fa-trash-alt"></i></button>
        <code v-html="nowProject.logContent"></code>

        <div class="drag-bar" :style="{ bottom: logHeight + 20 + 'px' }" @mousedown="logMoveBegin"></div>
        <div class="drag-move-area" v-show="logMoveStatus" @mousemove="logMoving"></div>
      </div>

      <div class="bottom-bar">
        <button class="function-btn" @click="addProjects"><i title="添加新项目" class="fas fa-plus"></i></button>
        <button class="function-btn" :disabled="nowProjectIdx === ''" @click="openProject"><i title="打开项目目录" class="far fa-folder-open"></i></button>
        <button class="function-btn" @click="aboutUs"><i title="关于" class="far fa-question-circle"></i></button>

        <div class="function-right-btns">
          <button class="function-btn" :class="{ 'log-mode': logMode }" @click="logMode = !logMode"><i title="查看日志" class="fas fa-terminal"></i></button>
        </div>
      </div>
    </div>

    <transition name="fade-in">
      <div class="page transparent-page page-info" v-if="infoMode">
        <div class="info-btns">
          <button class="info-btn" @click="openUrl('https://github.com/MiniCai/bag-tool/blob/master/README.md#config')"><i class="far fa-question-circle" title="帮助"></i></button>
          <button class="info-btn" @click="saveInfo"><i class="far fa-times-circle" title="保存并关闭"></i></button>
        </div>

        <div class="info-block">
          <header>项目配置</header>

          <main>
            <div class="form-tips">项目目录，路径相对当前项目</div>

            <div>
              <label class="form-row">
                <div class="form-label form-title">源目录</div>
                <input type="text" v-model="info.src">
              </label>
            </div>

            <div>
              <label class="form-row">
                <div class="form-label form-title">生产目录</div>
                <input type="text" v-model="info.dest">
              </label>
            </div>

            <div>
              <label class="form-row">
                <div class="form-label form-title">母版目录</div>
                <input type="text" v-model="info.template">
              </label>
            </div>

            <div class="form-tips">其余配置</div>

            <div>
              <label class="form-row">
                <div class="form-label form-title">编码集</div>
                <input type="text" v-model="info.encoding">
              </label>
            </div>

            <div>
              <label class="form-row">
                <input type="checkbox" v-model="info.showDetailLog">
                <div class="form-label">是否打印详细log</div>
              </label>
            </div>
          </main>
        </div>

        <div class="info-block">
          <header>LiveReload</header>

          <main>
            <div>
              <label class="form-row">
                <input type="checkbox" v-model="info.liveReload">
                <div class="form-label">开启 LiveReload 浏览器自动刷新</div>
              </label>
            </div>

            <div>
              <label class="form-row" v-show="info.liveReload">
                <input class="form-margin-left" type="text" v-model="info.startPath">
                <div class="form-label">默认加载的路径</div>
              </label>
            </div>
          </main>
        </div>

        <div class="info-block">
          <header>母版引擎</header>

          <main>
            <div class="form-tips">支持的文件后缀名</div>

            <div v-for="(extname, idx) in info.tmplExtname">
              <label class="form-row">
                <input type="text" v-model="extname">
                <button class="form-delete" @click="arrRemove(info.tmplExtname, idx)"></button>
              </label>
            </div>

            <div>
              <label class="form-row">
                <button class="form-add" @click="arrAdd(info.tmplExtname)"></button>
              </label>
            </div>
          </main>
        </div>

        <div class="info-block">
          <header>CSS预处理</header>

          <main>
            <div class="form-tips">勾选你需要使用的CSS预处理引擎：</div>

            <div>
              <label class="form-row">
                <input type="checkbox" v-model="info.cssEngine" value="less">
                <div class="form-label">Less</div>
              </label>
            </div>

            <div>
              <label class="form-row">
                <input type="checkbox" v-model="info.cssEngine" value="sass">
                <div class="form-label">Sass</div>
              </label>
            </div>
          </main>
        </div>

        <div class="info-block">
          <header>文件白名单</header>

          <main>
            <div class="form-tips">以下文件将直接复制到生产目录，路径相对源目录</div>

            <div v-for="(file, idx) in info.whiteList">
              <label class="form-row">
                <input class="long" type="text" v-model="file">
                <button class="form-delete" @click="arrRemove(info.whiteList, idx)"></button>
              </label>
            </div>

            <div>
              <label class="form-row">
                <button class="form-add" @click="arrAdd(info.whiteList)"></button>
              </label>
            </div>
          </main>
        </div>

        <div class="info-block">
          <header>忽略的文件或目录</header>

          <main>
            <div class="form-tips">路径相对源目录</div>

            <div v-for="(file, idx) in info.ignore">
              <label class="form-row">
                <input class="long" type="text" v-model="file">
                <button class="form-delete" @click="arrRemove(info.ignore, idx)"></button>
              </label>
            </div>

            <div>
              <label class="form-row">
                <button class="form-add" @click="arrAdd(info.ignore)"></button>
              </label>
            </div>
          </main>
        </div>
      </div>
    </transition>

    <transition name="fade-in">
      <div class="page transparent-page page-about" v-if="aboutMode">
        <img class="avatar" src="../../imgs/avatar.jpg" alt="头像" draggable="false">
        <div class="line version">Version: 0.0.1</div>
        <div class="line author">Author: <a href="javascript:;" @click="openUrl('https://github.com/JaminQ')">Jamin Qian</a></div>
        <div class="line link">
          <a href="javascript:;" @click="openUrl('https://github.com/MiniCai/bag-tool')">Github</a>
          ,
          <a href="javascript:;" @click="openUrl('https://www.npmjs.com/package/bag-tool')">NPM</a>
          ,
          <a href="javascript:;" @click="openUrl('https://github.com/MiniCai/bag-tool/blob/master/README.md')">README</a>
        </div>
        <button class="btn like" @click="closeAboutPage"><i class="far fa-thumbs-up"></i> Good</button>
      </div>
    </transition>
  </bag-slot>

  <bag-slot name="script">
    <script type="text/javascript">
      require('./home.js');
    </script>
  </bag-slot>
</bag-include>